<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Gerenciamento de Rotas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-light">

<div class="container mt-4">
    <div class="card shadow-lg p-4 mb-4">
        <h2 class="text-primary mb-3">Gerenciamento de Rotas</h2>

        <form th:action="@{/routes/manage}" th:object="${route}" method="post" id="routeForm">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label for="origin" class="form-label">Central de Distribui√ß√£o</label>
                    <select class="form-select" id="origin" th:field="*{origin.id}" required>
                        <option value="">Selecione...</option>
                        <option th:each="center : ${centers}"
                                th:value="${center.id}"
                                th:data-lat="${center.latitude}"
                                th:data-lon="${center.longitude}"
                                th:text="${center.name}">
                        </option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label for="destinationAddress" class="form-label">Destino</label>
                    <input type="text" id="destinationAddress"
                           th:field="*{destinationAddress}"
                           class="form-control"
                           placeholder="Digite o endere√ßo ou CEP" required>
                </div>

                <div class="col-md-3">
                    <label for="truck" class="form-label">Caminh√£o</label>
                    <select class="form-select" name="truckId" required>
                        <option value="">Selecione...</option>
                        <option th:each="truck : ${trucks}" th:value="${truck.id}"
                                th:text="${truck.plate + ' - ' + truck.model}"></option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label for="speed" class="form-label">Velocidade M√©dia</label>
                    <select id="speed" class="form-select">
                        <option value="30">30 km/h</option>
                        <option value="40">40 km/h</option>
                        <option value="50">50 km/h</option>
                        <option value="60" selected>60 km/h</option>
                    </select>
                </div>

                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-primary w-100" onclick="calcularRota()">Calcular Rota</button>
                </div>
            </div>

            <input type="hidden" id="destinationLatitude" th:field="*{destinationLatitude}">
            <input type="hidden" id="destinationLongitude" th:field="*{destinationLongitude}">
            <input type="hidden" id="distanceKm" th:field="*{distanceKm}">
            <input type="hidden" id="durationMin" th:field="*{durationMin}">
            <input type="hidden" id="averageSpeed" th:field="*{averageSpeed}">


            <div class="text-end">
                <a th:href="@{/routes/menu}" class="btn btn-secondary mt-2">Voltar</a>
                <button type="submit" id="saveBtn" class="btn btn-success mt-2" disabled>Salvar Rota</button>
            </div>
        </form>

        <div id="map" style="height: 400px" class="mt-4"></div>
    </div>

    <div class="card shadow-lg p-4">
        <h4 class="text-secondary mb-3">Rotas Cadastradas</h4>
        <table class="table table-striped align-middle">
            <thead>
            <tr>
                <th>ID</th>
                <th>Central Origem</th>
                <th>Destino</th>
                <th>Dist√¢ncia</th>
                <th>Tempo</th>
                <th>Velocidade M√©dia</th>
                <th class="text-center">A√ß√µes</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="route : ${routes}">
                <td th:text="${route.id}"></td>
                <td th:text="${route.origin.name}"></td>
                <td th:text="${route.destinationAddress}"></td>
                <td th:text="${#numbers.formatDecimal(route.distanceKm, 0, 'POINT', 2, 'POINT')} + ' km'"></td>
                <td th:text="${route.durationMin} + ' min'"></td>
                <td th:text="${route.averageSpeed} + ' km/h'"></td> <!-- üëà Novo -->
                <td class="text-center">
                    <a href="#" class="btn btn-primary btn-sm"
                       th:attr="data-orilat=${route.origin.latitude},
                    data-orilon=${route.origin.longitude},
                    data-destlat=${route.destinationLatitude},
                    data-destlon=${route.destinationLongitude},
                    data-dist=${route.distanceKm},
                    data-time=${route.durationMin},
                    data-speed=${route.averageSpeed},
                    data-originname=${route.origin.name}"
                       onclick="verRota(this)">Ver</a>
                    <a th:href="@{'/routes/' + ${route.id} + '/delete'}"
                       class="btn btn-danger btn-sm"
                       onclick="return confirm('Tem certeza que deseja excluir esta rota?');">
                        Excluir
                    </a>
                    <a th:href="@{'/collections/status?(routeId=' + ${route.id} + ')'}"
                       class="btn btn-success btn-sm">
                        Agendar coleta
                    </a>
                </td>
            </tr>
            <tr th:if="${#lists.isEmpty(routes)}">
                <td colspan="7" class="text-center text-muted">Nenhuma rota cadastrada.</td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    var map = L.map('map').setView([-23.55, -46.63], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    var routeLayer, originMarker, destMarker;

    var originIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/252/252025.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });

    var destIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
        iconSize: [40, 40],
        iconAnchor: [20, 40],
        popupAnchor: [0, -40]
    });

    function calcularRota() {
        var originSelect = document.getElementById("origin").selectedOptions[0];
        if (!originSelect) { alert("Selecione uma central de origem."); return; }
        var originLat = originSelect.dataset.lat;
        var originLon = originSelect.dataset.lon;

        var destino = document.getElementById("destinationAddress").value;
        if (!destino) { alert("Digite o endere√ßo ou CEP do destino."); return; }

        fetch("https://nominatim.openstreetmap.org/search?format=json&q=" + encodeURIComponent(destino))
            .then(res => res.json())
            .then(data => {
                if (data.length === 0) { alert("Endere√ßo n√£o encontrado."); return; }

                var destLat = data[0].lat;
                var destLon = data[0].lon;

                document.getElementById("destinationLatitude").value = destLat;
                document.getElementById("destinationLongitude").value = destLon;

                var url = "https://router.project-osrm.org/route/v1/driving/"
                    + originLon + "," + originLat + ";"
                    + destLon + "," + destLat
                    + "?overview=full&geometries=geojson";

                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        var route = data.routes[0];
                        var distanciaKm = (route.distance / 1000).toFixed(2);

                        var speed = document.getElementById("speed").value;

                        document.getElementById("averageSpeed").value = speed;

                        var duracaoMin = ((distanciaKm / speed) * 60).toFixed(0);

                        document.getElementById("distanceKm").value = distanciaKm;
                        document.getElementById("durationMin").value = duracaoMin;
                        document.getElementById("saveBtn").disabled = false;

                        if (routeLayer) map.removeLayer(routeLayer);
                        if (originMarker) map.removeLayer(originMarker);
                        if (destMarker) map.removeLayer(destMarker);

                        var coords = route.geometry.coordinates;
                        var latlngs = coords.map(c => [c[1], c[0]]);
                        routeLayer = L.polyline(latlngs, {color: 'blue', weight: 5}).addTo(map);

                        originMarker = L.marker([originLat, originLon], {icon: originIcon})
                            .addTo(map)
                            .bindPopup("Central de Origem: " + originSelect.text);

                        destMarker = L.marker([destLat, destLon], {icon: destIcon})
                            .addTo(map)
                            .bindPopup(
                                "Destino<br>" +
                                "Dist√¢ncia: " + distanciaKm + " km<br>" +
                                "Tempo: " + duracaoMin + " min<br>" +
                                "Velocidade m√©dia: " + speed + " km/h"
                            );

                        map.fitBounds(routeLayer.getBounds());
                    });
            });
    }

    function verRota(el) {
        var originLat = el.getAttribute("data-orilat");
        var originLon = el.getAttribute("data-orilon");
        var destLat = el.getAttribute("data-destlat");
        var destLon = el.getAttribute("data-destlon");
        var distanciaKm = el.getAttribute("data-dist");
        var duracaoMin = el.getAttribute("data-time");
        var originName = el.getAttribute("data-originname");

        if (routeLayer) map.removeLayer(routeLayer);
        if (originMarker) map.removeLayer(originMarker);
        if (destMarker) map.removeLayer(destMarker);

        var url = "https://router.project-osrm.org/route/v1/driving/"
            + originLon + "," + originLat + ";"
            + destLon + "," + destLat
            + "?overview=full&geometries=geojson";

        fetch(url)
            .then(response => response.json())
            .then(data => {
                var route = data.routes[0];
                var coords = route.geometry.coordinates;
                var latlngs = coords.map(c => [c[1], c[0]]);
                routeLayer = L.polyline(latlngs, {color: 'blue', weight: 5}).addTo(map);

                originMarker = L.marker([originLat, originLon], {icon: originIcon})
                    .addTo(map).bindPopup("Central de Origem: " + originName);
                destMarker = L.marker([destLat, destLon], {icon: destIcon})
                    .addTo(map).bindPopup("Destino<br>Dist√¢ncia: " + distanciaKm + " km<br>Tempo: " + duracaoMin + " min");

                map.fitBounds(routeLayer.getBounds());
            });
    }
</script>

</body>
</html>
