<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>J√° Chegou</title>

  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#00264d"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;background:#f8fafc}
    .topbar{position:sticky;top:0;background:#00264d;color:#fff;padding:12px 16px;z-index:10;font-weight:700}
    .container{padding:16px;max-width:640px;margin:0 auto}
    .card{background:#fff;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06);padding:16px;margin-bottom:12px}
    .btn{appearance:none;border:0;background:#007f3d;color:#fff;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;transition:background .2s}
    .btn:hover{background:#006b34}
    .row{display:flex;gap:8px}
    .grow{flex:1}
    #map{height:420px;width:100%;border-radius:12px}
    .bottomnav{position:sticky;bottom:0;background:#fff;border-top:1px solid #e5e7eb;padding:8px;display:flex;gap:8px;justify-content:space-around}
    /* --- anima√ß√£o de fade do modal --- */
    .modal.fade .modal-dialog{transform:translateY(-30px);opacity:0;transition:all .35s ease-out}
    .modal.show .modal-dialog{transform:translateY(0);opacity:1}
    /* --- legenda no mapa --- */
    .legend{background:#fff;padding:8px;border-radius:10px;font-size:.9em;
      box-shadow:0 3px 6px rgba(0,0,0,.2);position:absolute;bottom:15px;left:15px;z-index:1000}
    .legend div{margin:2px 0}
  </style>
</head>
<body>
<header class="topbar">J√° Chegou</header>

<main class="container">
  <section class="card">
    <h1 style="margin:0">Mapa do J√° Chegou</h1>
    <p style="margin-top:8px" id="statusText" th:text="${logged} ? 'Visualiza√ß√£o em tempo real dos caminh√µes.' : 'Veja as rotas dispon√≠veis e acompanhe o servi√ßo.'"></p>
  </section>

  <section class="card">
    <div id="map"></div>
    <!-- legenda -->
    <div class="legend">
      <div>üü¢ Origem</div>
      <div>üîµ Destino</div>
      <div>üöõ Caminh√£o</div>
    </div>
  </section>

  <section class="card row">
    <!-- bot√£o vis√≠vel para todos -->
    <button class="btn grow" id="btnShowRoutes" onclick="showRoutes()">Ver rotas dispon√≠veis</button>

    <!-- bot√µes extras se N√ÉO logado -->
    <button class="btn grow" th:if="${!logged}" onclick="location.href='/login'">Entrar</button>
    <button class="btn grow" th:if="${!logged}" onclick="location.href='/cadastro'">Cadastrar</button>

    <!-- bot√µes extras se logado -->
    <button class="btn grow" th:if="${logged}" onclick="location.href='/me'">Minha conta</button>
    <button id="btnAlerts" class="btn grow" th:if="${logged}" onclick="enableAlerts()" disabled>Ativar alertas</button>
  </section>

</main>

<nav class="bottomnav">
  <button class="btn grow" onclick="location.href='/'">Home</button>
  <button class="btn grow" th:if="${!logged}" onclick="location.href='/login'">Entrar</button>
  <button class="btn grow" th:if="${!logged}" onclick="location.href='/cadastro'">Cadastrar</button>
  <button class="btn grow" th:if="${logged}"  onclick="location.href='/me'">Minha conta</button>
</nav>

<!-- Modal de rotas -->
<div class="modal fade" id="rotasModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Rotas dispon√≠veis</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="routeList" class="list-group"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script th:inline="javascript">
  const API_BASE = location.origin;
  const logged = /*[[${logged}]]*/ false;
  console.log("P√°gina carregada. Usu√°rio logado:", logged);

  if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});

  const map = L.map('map').setView([-23.55, -46.63], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution:'¬© OpenStreetMap' }).addTo(map);

  const truckIcon = L.icon({ iconUrl:'/icons/icon-192.png', iconSize:[40,40], iconAnchor:[20,20] });

  let routeLayer = null;
  let truckMarkers = {};

  async function showRoutes() {
    console.log("showRoutes() chamada");

    try {
      const res = await fetch(API_BASE + '/api/routes/public', { credentials: 'include' });
      if (!res.ok) throw new Error(`Erro HTTP ${res.status}`);

      const routes = await res.json();
      if (!routes.length) {
        alert("Nenhuma rota cadastrada.");
        return;
      }

      const list = document.getElementById('routeList');
      if (!list) {
        console.error("Elemento #routeList n√£o encontrado no DOM.");
        return;
      }

      list.innerHTML = '';
      routes.forEach(r => {
        const item = document.createElement('button');
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.innerHTML = `
        <span>${r.originName || 'Origem desconhecida'} ‚Üí ${r.name || 'Destino desconhecido'}</span>
        <span class="badge bg-success">Ver</span>`;
        item.addEventListener('click', () => drawRoute(r));
        list.appendChild(item);
      });

      const modalEl = document.getElementById('rotasModal');
      const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
      modal.show();

    } catch (e) {
      console.error("Erro ao carregar rotas:", e);
      alert("Erro ao carregar rotas.");
    }
  }

  // --- anima√ß√£o suave dos caminh√µes em tempo real ---
  if(logged){
    async function updateTrucks(){
      try{
        const res=await fetch(API_BASE+'/api/trucks/public/live');
        if(!res.ok) return;
        const trucks=await res.json();

        trucks.forEach(t=>{
          if(!t.lat||!t.lng) return;
          const id=String(t.id);
          const newPos=L.latLng(t.lat,t.lng);

          // se ainda n√£o existe o marcador, adiciona com fade-in
          if(!truckMarkers[id]){
            const marker=L.marker(newPos,{icon:truckIcon,opacity:0}).addTo(map);
            truckMarkers[id]=marker;
            let op=0;
            const fade=setInterval(()=>{
              op+=0.1;
              marker.setOpacity(op);
              if(op>=1) clearInterval(fade);
            },40);
          } else {
            // anima√ß√£o suave entre posi√ß√µes
            const marker=truckMarkers[id];
            const start=marker.getLatLng();
            const duration=1000; // 1s de transi√ß√£o
            const startTime=performance.now();

            function animate(time){
              const progress=Math.min((time-startTime)/duration,1);
              const lat=start.lat+(newPos.lat-start.lat)*progress;
              const lng=start.lng+(newPos.lng-start.lng)*progress;
              marker.setLatLng([lat,lng]);
              if(progress<1) requestAnimationFrame(animate);
            }
            requestAnimationFrame(animate);
          }
        });
      }catch(e){console.error(e);}
    }
    setInterval(updateTrucks,3000);
  }

  window.addEventListener('DOMContentLoaded', () => {
    const btnShow = document.getElementById('btnShowRoutes');
    if (btnShow) {
      btnShow.addEventListener('click', showRoutes);
      console.log("Evento de clique adicionado ao bot√£o 'Ver rotas dispon√≠veis'");
    }

    const btnAlerts = document.getElementById('btnAlerts');
    if (btnAlerts) {
      btnAlerts.removeAttribute('disabled');
    }
  });


  // --- Fun√ß√£o para ativar notifica√ß√µes ---
  async function enableAlerts() {
    console.log("üü¢ enableAlerts() foi chamada");

    if (!('serviceWorker' in navigator) || !('PushManager' in window) || !('Notification' in window)) {
      alert("Seu navegador n√£o suporta notifica√ß√µes push.");
      return;
    }

    const perm = await Notification.requestPermission();
    if (perm !== 'granted') {
      alert("Permiss√£o de notifica√ß√£o negada.");
      return;
    }

    const reg = await navigator.serviceWorker.ready;
    const vapidPublicKey = "BNpv_xHzO1ton3ihU5gYirNuEJRp8q-5y2KZVLER6Um0ciJiXAWNtvFnZP80cuCW6eUueDTYhUlCWRkZuYqtXAE";

    // Converte a chave p√∫blica (base64 ‚Üí Uint8Array)
    function urlBase64ToUint8Array(base64String) {
      const padding = "=".repeat((4 - (base64String.length % 4)) % 4);
      const base64 = (base64String + padding).replace(/-/g, "+").replace(/_/g, "/");
      const rawData = atob(base64);
      const outputArray = new Uint8Array(rawData.length);
      for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
      return outputArray;
    }

    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
    });

    console.log("Subscri√ß√£o de Push criada:", sub);

    await fetch(API_BASE + '/api/notifications/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(sub),
      credentials: 'include'
    });

    alert("Notifica√ß√µes ativadas com sucesso!");
    const btn = document.getElementById('btnAlerts');
    btn.textContent = 'Alertas ativados';
    btn.disabled = true;
  }

  function drawRoute(route) {
    console.log("Desenhando rota:", route.name || "sem nome");

    // Remove rota anterior se existir
    if (window.routeLayer) {
      map.removeLayer(window.routeLayer);
    }

    if (!route.coordinates || route.coordinates.length === 0) {
      alert("Esta rota n√£o possui coordenadas registradas.");
      return;
    }

    window.routeLayer = L.polyline(route.coordinates, { color: 'green', weight: 5 }).addTo(map);

    map.fitBounds(window.routeLayer.getBounds(), { padding: [30, 30] });

    const start = route.coordinates[0];
    const end = route.coordinates[route.coordinates.length - 1];

    const iconStart = L.divIcon({ className: 'custom-icon-start', html: 'üü¢', iconSize: [20, 20] });
    const iconEnd = L.divIcon({ className: 'custom-icon-end', html: 'üîµ', iconSize: [20, 20] });

    if (window.startMarker) map.removeLayer(window.startMarker);
    if (window.endMarker) map.removeLayer(window.endMarker);

    window.startMarker = L.marker(start, { icon: iconStart }).addTo(map).bindPopup("Origem");
    window.endMarker = L.marker(end, { icon: iconEnd }).addTo(map).bindPopup("Destino");

    const modalEl = document.getElementById('rotasModal');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();

    console.log("Rota exibida no mapa com sucesso!");
  }


</script>
</body>
</html>
