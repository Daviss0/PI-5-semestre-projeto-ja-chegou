<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Cadastro de Cliente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #0d0d0d;
            color: #fff;
            font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .container {
            background-color: #111;
            border: 1px solid #222;
            border-radius: 1rem;
            padding: 2.5rem;
            margin-top: 3rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        h2, h5 {
            color: #fff;
            font-weight: 600;
        }

        label {
            color: #ccc;
            font-weight: 500;
        }

        .form-control {
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            border-radius: 0.75rem;
            padding: 0.8rem;
        }

        .form-control::placeholder {
            color: #666;
        }

        .btn-success {
            background-color: #fff;
            color: #000;
            font-weight: 600;
            border-radius: 0.75rem;
            padding: 0.7rem 2rem;
            border: none;
            transition: 0.2s;
        }

        .btn-success:hover {
            background-color: #e5e5e5;
        }

        .btn-outline-secondary {
            color: #ccc;
            border: 1px solid #333;
            border-radius: 0.75rem;
            padding: 0.7rem 1.8rem;
        }

        .btn-outline-secondary:hover {
            background-color: #1f1f1f;
            color: #fff;
        }

        hr {
            border-color: #222;
        }

        .alert-success {
            background-color: #0f5132;
            border: 1px solid #198754;
            color: #d1e7dd;
            border-radius: 0.75rem;
        }

        .alert-danger {
            background-color: #58151c;
            border: 1px solid #dc3545;
            color: #f8d7da;
            border-radius: 0.75rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h2 class="mb-4 text-center">Cadastro de Cliente</h2>
    <form id="registerForm">
        <div class="row">
            <!-- Dados Pessoais -->
            <h5 class="mb-3">Dados Pessoais</h5>

            <div class="col-md-6 mb-3">
                <label>Nome Completo</label>
                <input type="text" id="name" class="form-control" required placeholder="Seu nome completo">
            </div>

            <div class="col-md-3 mb-3">
                <label>CPF</label>
                <input type="text" id="cpf" name="cpf" class="form-control" maxlength="14" placeholder="000.000.000-00" required>
            </div>

            <div class="col-md-3 mb-3">
                <label>Data de Nascimento</label>
                <input type="date" id="birthDate" class="form-control" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>E-mail</label>
                <input type="email" id="email" class="form-control" required placeholder="email@dominio.com"
                       autocomplete="off">
            </div>

            <div class="col-md-3 mb-3">
                <label>Telefone</label>
                <input type="text" id="phone" class="form-control" maxlength="11" required placeholder="(99)99999-9999">
            </div>

            <div class="col-md-3 mb-3">
                <label>Senha</label>
                <input type="password" id="password" class="form-control" minlength="6"
                       required placeholder="Mínimo 6 caracteres" autocomplete="new-password">
            </div>

            <hr class="mt-4 mb-3">

            <!-- Endereço -->
            <h5 class="mb-3">Endereço</h5>

            <div class="col-md-3 mb-3">
                <label>CEP</label>
                <input type="text" id="cep" name="cep" class="form-control" maxlength="9" placeholder="00000-000" required>
            </div>

            <div class="col-md-6 mb-3">
                <label>Logradouro</label>
                <input type="text" id="logradouro" class="form-control" required placeholder="Rua, avenida...">
            </div>

            <div class="col-md-3 mb-3">
                <label>Número</label>
                <input type="text" id="number" class="form-control" required>
            </div>

            <div class="col-md-4 mb-3">
                <label>Complemento</label>
                <input type="text" id="complement" class="form-control" placeholder="Opcional">
            </div>

            <div class="col-md-4 mb-3">
                <label>Bairro</label>
                <input type="text" id="hood" class="form-control" required>
            </div>

            <div class="col-md-3 mb-3">
                <label>Cidade</label>
                <input type="text" id="city" class="form-control" required>
            </div>

            <div class="col-md-1 mb-3">
                <label>UF</label>
                <input type="text" id="state" class="form-control" maxlength="2" required>
            </div>
        </div>

        <div class="text-center mt-4">
            <button type="submit" class="btn btn-success px-4">Cadastrar</button>
            <a href="/mainPage" class="btn btn-outline-secondary ms-2">Voltar</a>
        </div>

        <div id="msg" class="mt-4 text-center"></div>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const cpfInput = document.getElementById('cpf');
        const cepInput = document.getElementById('cep');
        const form = document.getElementById('registerForm');
        const msgEl = document.getElementById('msg');

        // Máscara CPF
        cpfInput.addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 11) v = v.slice(0, 11);
            v = v.replace(/^(\d{3})(\d)/, '$1.$2')
                .replace(/^(\d{3})\.(\d{3})(\d)/, '$1.$2.$3')
                .replace(/\.(\d{3})(\d)/, '.$1-$2');
            e.target.value = v;
        });

        // Máscara CEP
        cepInput.addEventListener('input', (e) => {
            let v = e.target.value.replace(/\D/g, '');
            if (v.length > 8) v = v.slice(0, 8);
            if (v.length > 5) v = v.replace(/(\d{5})(\d)/, '$1-$2');
            e.target.value = v;
        });

        // Consulta CEP
        cepInput.addEventListener('blur', async () => {
            const cep = cepInput.value.replace(/\D/g, '');
            if (cep.length === 8) {
                try {
                    const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                    const data = await res.json();

                    if (!data.erro) {
                        document.getElementById('logradouro').value = data.logradouro || '';
                        document.getElementById('hood').value = data.bairro || '';
                        document.getElementById('city').value = data.localidade || '';
                        document.getElementById('state').value = data.uf || '';
                    } else {
                        alert("CEP não encontrado.");
                    }
                } catch (err) {
                    console.error("Erro ao consultar ViaCEP:", err);
                }
            } else if (cep.length > 0) {
                alert("CEP deve ter 8 dígitos numéricos.");
            }
        });

        // Envio do formulário
        form.addEventListener('submit', async e => {
            e.preventDefault();

            const cpfLimpo = cpfInput.value.replace(/\D/g, '');
            const cepLimpo = cepInput.value.replace(/\D/g, '');

            const data = {
                name: document.getElementById('name').value.trim(),
                cpf: cpfLimpo,
                email: document.getElementById('email').value.trim(),
                password: document.getElementById('password').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                birthDate: document.getElementById('birthDate').value,
                cep: cepLimpo,
                logradouro: document.getElementById('logradouro').value.trim(),
                number: document.getElementById('number').value.trim(),
                complement: document.getElementById('complement').value.trim(),
                hood: document.getElementById('hood').value.trim(),
                city: document.getElementById('city').value.trim(),
                state: document.getElementById('state').value.trim()
            };

            try {
                const res = await fetch('/api/clients/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                msgEl.innerHTML = ''; // limpa mensagens antigas

                if (res.ok) {
                    msgEl.innerHTML = `
                        <div class="alert alert-success mt-3">
                            Cadastro realizado com sucesso! Redirecionando para a tela de login...
                        </div>`;
                    setTimeout(() => window.location.href = '/client/login', 2000);
                } else {
                    const err = await res.text();
                    msgEl.innerHTML = `<div class="alert alert-danger mt-3">${err}</div>`;
                }
            } catch (err) {
                console.error('Erro no envio do cadastro:', err);
                msgEl.innerHTML = `<div class="alert alert-danger mt-3">Erro ao conectar ao servidor.</div>`;
            }
        });
    });
</script>
</body>
</html>
