<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Status das Coletas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <meta th:if="${_csrf != null}" name="_csrf" th:content="${_csrf.token}">
  <meta th:if="${_csrf != null}" name="_csrf_header" th:content="${_csrf.headerName}">
</head>

<body class="bg-light">

<div class="container mt-4">

  <h2 class="text-primary mb-3">Status das Coletas</h2>

  <!-- Mensagens -->
  <div th:if="${msg}" class="alert alert-success alert-dismissible fade show">
    <span th:text="${msg}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div th:if="${err}" class="alert alert-warning alert-dismissible fade show">
    <span th:text="${err}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <!-- Filtros -->
  <form class="row g-2 mb-3" method="get" th:action="@{/collections/status}">
    <div class="col-md-3">
      <label class="form-label">Status</label>
      <select class="form-select" name="status">
        <option value="">Todos</option>
        <option th:each="s : ${statusValues}" th:value="${s}" th:text="${s}" th:selected="${statusFilter} == s"></option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">De</label>
      <input type="date" class="form-control" name="from" th:value="${from}">
    </div>

    <div class="col-md-3">
      <label class="form-label">At√©</label>
      <input type="date" class="form-control" name="to" th:value="${to}">
    </div>

    <div class="col-md-3 d-flex align-items-end">
      <button class="btn btn-outline-primary w-100">Filtrar</button>
    </div>
  </form>

  <!-- Agendamento -->
  <div class="card shadow-sm p-3 mb-4">
    <h5 class="mb-3">Agendar coleta</h5>

    <form class="row g-2" method="post" th:action="@{/collections/schedule}">
      <div class="col-md-3">
        <label class="form-label">Rota</label>
        <select class="form-select" name="routeId" required>
          <option value="">Selecione...</option>
          <option th:each="r : ${routes}"
                  th:value="${r.id}"
                  th:text="'Linha ' + ${r.codigoLinhaOlhoVivo}"
                  th:selected="${prefRouteId != null and r.id == prefRouteId}">
          </option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Caminh√£o</label>
        <select class="form-select" name="truckId" required>
          <option value="">Selecione...</option>
          <option th:each="t : ${trucks}" th:value="${t.id}" th:text="${t.plate + ' - ' + t.model}"></option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Motorista</label>
        <select class="form-select" name="driverId" required>
          <option value="">Selecione...</option>
          <option th:each="d : ${drivers}" th:value="${d.id}" th:text="${d.name}"></option>
        </select>
      </div>

      <div class="col-md-3">
        <label class="form-label">Data/Hora</label>
        <input type="datetime-local" class="form-control" name="when" required>
      </div>

      <div class="col-12">
        <label class="form-label">Observa√ß√µes</label>
        <input type="text" class="form-control" name="notes" placeholder="Opcional">
      </div>

      <div class="col-12 text-end">
        <button class="btn btn-success mt-2">Agendar</button>
      </div>
    </form>
  </div>

  <!-- Lista -->
  <div class="card shadow-sm p-3">

    <table class="table table-hover align-middle">
      <thead>
      <tr>
        <th>#</th>
        <th>Rota</th>
        <th>Agendada</th>
        <th>In√≠cio</th>
        <th>Fim</th>
        <th>Status</th>
        <th>Caminh√£o</th>
        <th>Motorista</th>
        <th class="text-center">A√ß√µes</th>
      </tr>
      </thead>

      <tbody>

      <tr th:each="c : ${collections}">
        <td th:text="${c.id}"></td>

        <td>
          <b>Linha SPTrans </b>
          <span th:text="${c.route.codigoLinhaOlhoVivo}"></span>
        </td>

        <td th:text="${#temporals.format(c.scheduledAt, 'dd/MM HH:mm')}"></td>

        <td th:text="${c.startedAt != null ? #temporals.format(c.startedAt, 'dd/MM HH:mm') : '-'}"></td>

        <td th:text="${c.finishedAt != null ? #temporals.format(c.finishedAt, 'dd/MM HH:mm') : '-'}"></td>

        <td>
          <span th:classappend="${c.status.name()=='AGENDADA' ? 'badge bg-secondary' :
                                c.status.name()=='EM_ANDAMENTO' ? 'badge bg-primary' :
                                c.status.name()=='CONCLUIDA' ? 'badge bg-success' : 'badge bg-danger'}"
                th:text="${c.status}"></span>
        </td>

        <td th:text="${c.truck.plate}"></td>
        <td th:text="${c.driver.name}"></td>

        <td class="text-center">
          <button class="btn btn-outline-primary btn-sm"
                  th:onclick="|monitorarLinha(${c.route.codigoLinhaOlhoVivo}, ${c.client.latitude}, ${c.client.longitude})|">
            Monitorar
          </button>

          <button class="btn btn-success btn-sm"
                  th:if="${c.status.name() == 'EM_ANDAMENTO'}"
                  data-bs-toggle="modal"
                  th:attr="data-bs-target=${'#finishModal-' + c.id}">
            Concluir
          </button>

          <form th:action="@{'/collections/' + ${c.id} + '/cancel'}"
                method="post" class="d-inline"
                th:if="${c.status.name() != 'CONCLUIDA' && c.status.name() != 'CANCELADA'}">

            <input th:if="${_csrf != null}" type="hidden"
                   th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
            <input type="hidden" name="reason" value="Cancelado via backoffice">

            <button class="btn btn-outline-danger btn-sm" type="submit">Cancelar</button>
          </form>
        </td>

      </tr>

      <tr th:if="${#lists.isEmpty(collections)}">
        <td colspan="9" class="text-center text-muted">Nenhuma coleta encontrada.</td>
      </tr>

      </tbody>
    </table>
  </div>

  <div id="map" class="mt-3" style="height: 380px;"></div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>

  let map = L.map('map').setView([-23.55, -46.63], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
  }).addTo(map);

  /* ===========================================================
     üîµ CAMADAS DO MAPA
  =========================================================== */
  let shapeLayer = null;      // polyline do trajeto real SPTrans
  let truckMarkers = [];      // caminh√µes monitorados
  let monitorTimer = null;    // timer para atualizar realtime

  /* ===========================================================
     üî• FUN√á√ÉO: Desenhar o SHAPE real salvo no banco
  =========================================================== */
  function desenharShapeDaRota(route) {
    if (!route.coordinates || route.coordinates.length === 0) return;

    if (shapeLayer) map.removeLayer(shapeLayer);

    const latlngs = route.coordinates.map(c => [c.lat, c.lng]);

    shapeLayer = L.polyline(latlngs, {
      color: "#1E90FF",
      weight: 6,
      opacity: 0.85
    }).addTo(map);

    map.fitBounds(shapeLayer.getBounds(), { padding: [40, 40] });
  }

  /* ===========================================================
     üî• BUSCA ve√≠culos reais da linha SPTrans
  =========================================================== */
  async function buscarCaminhoesOlhoVivo(codigoLinha) {
    try {
      const res = await fetch(`/api/olhoVivo/veiculos/${codigoLinha}`);
      const json = await res.json();
      return json.vs || [];
    } catch (e) {
      console.error("Erro ao buscar caminh√µes:", e);
      return [];
    }
  }

  /* ===========================================================
     üî• MONITORAMENTO EM TEMPO REAL (CORA√á√ÉO DO SISTEMA)
  =========================================================== */
  async function monitorarLinha(codigoLinha, clientLat, clientLng) {

    // Remove marcadores antigos
    truckMarkers.forEach(m => map.removeLayer(m));
    truckMarkers = [];

    const veiculos = await buscarCaminhoesOlhoVivo(codigoLinha);
    if (!veiculos || veiculos.length === 0) return;

    veiculos.forEach(v => {
      const pos = [v.py, v.px];

      // Dist√¢ncia cliente ‚Üí caminh√£o
      const distKm = calcularDistanciaKm(clientLat, clientLng, pos[0], pos[1]);
      const metros = Math.round(distKm * 1000);

      // Cor por proximidade
      const cor =
              distKm < 0.5 ? "#00ff9d" :
                      distKm < 1.0 ? "#ffcc00" :
                              "#ff4444";

      const marker = L.circleMarker(pos, {
        radius: 10,
        weight: 3,
        color: "#000",
        fillColor: cor,
        fillOpacity: 1
      })
              .addTo(map)
              .bindPopup(`
            <b>üöå Caminh√£o Real</b><br>
            Linha: ${codigoLinha}<br>
            ID: ${v.vs || '?'}<br>
            Vel.: ${v.sp || 0} km/h<br>
            Dist√¢ncia: ${metros} m
        `);

      truckMarkers.push(marker);

      // Alerta especial se o caminh√£o est√° chegando
      if (distKm < 0.30) {
        mostrarAvisoTopo("üöö Seu caminh√£o est√° muito pr√≥ximo!");
      }
    });

    // Atualiza a cada 8s
    clearTimeout(monitorTimer);
    monitorTimer = setTimeout(() => monitorarLinha(codigoLinha, clientLat, clientLng), 8000);
  }

  /* ===========================================================
     üî¢ Fun√ß√£o utilit√°ria ‚Äî dist√¢ncia haversine
  =========================================================== */
  function calcularDistanciaKm(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;

    const a = Math.sin(dLat / 2) ** 2 +
            Math.cos(lat1 * Math.PI/180) * Math.cos(lat2*Math.PI/180) *
            Math.sin(dLon / 2) ** 2;

    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
  }

  /* ===========================================================
     üöÄ INICIALIZA√á√ÉO DA P√ÅGINA
  =========================================================== */
  document.addEventListener("DOMContentLoaded", () => {

    // Vari√°veis vinda do backend (Thymeleaf)
    const linha = [[${job.route.codigoLinhaOlhoVivo}]];
    const clientLat = [[${job.client.latitude}]];
    const clientLng = [[${job.client.longitude}]];

    const route = [[${job.route}]];

    // Desenha o trajeto real salvo no banco
    desenharShapeDaRota(route);

    // Inicia o monitoramento realtime
    monitorarLinha(linha, clientLat, clientLng);
  });

</script>


</body>
</html>
